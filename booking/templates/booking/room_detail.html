{% extends 'booking/base.html' %}
{% load static %} <!-- ตรวจสอบให้แน่ใจว่ามีบรรทัดนี้อยู่ด้านบน -->

{% block title %}จองห้อง {{ room.name }}{% endblock %}

{% block content %}
<div class="p-3 my-4 bg-white rounded shadow-sm">

    <!-- ===== ส่วนแสดงรูปภาพ (แก้ไขแล้ว) ===== -->
    {% if room.image.url %}
        <img src="{{ room.image.url }}" class="img-fluid rounded mb-4" alt="รูปภาพห้อง {{ room.name }}" style="max-height: 400px; width: 100%; object-fit: cover;">
    {% else %}
        <!-- เปลี่ยนมาใช้รูปภาพ default จาก static files -->
        <img src="{% static 'booking/images/default_room.png' %}" class="img-fluid rounded mb-4" alt="ไม่มีรูปภาพ" style="max-height: 400px; width: 100%; object-fit: cover;">
    {% endif %}
    <!-- ========================================== -->

    <h1>{{ room.name }}</h1>
    <p class="lead text-muted"><strong>รหัสห้อง:</strong> {{ room.room_id }} | <strong>ความจุ:</strong> {{ room.capacity }} คน</p>

    <hr>

    <!-- ฟอร์มที่ 1: สำหรับเลือกวันและกดตรวจสอบ (GET) -->
    <form method="get" class="mb-4 p-3 border rounded bg-light">
        <h3>1. เลือกวันที่</h3>
        <div class="row align-items-end">
            <div class="col-md-5">
                {% if user.is_staff %}
                    <p class="text-muted small">คุณสามารถจองล่วงหน้าได้</p>
                    <input type="date" name="date" class="form-control" value="{{ selected_date|default:'' }}" min="{{ today_date }}" required>
                {% else %}
                    <p class="text-muted small">คุณสามารถจองได้เฉพาะวันนี้เท่านั้น</p>
                    <input type="date" name="date" class="form-control" value="{{ selected_date|default:today_date }}" min="{{ today_date }}" max="{{ today_date }}" required>
                {% endif %}
            </div>
            <div class="col-md-4">
                <button type="submit" class="btn btn-primary">ตรวจสอบเวลาว่าง</button>
            </div>
        </div>
    </form>

    <!-- ฟอร์มที่ 2: สำหรับเลือกเวลาและยืนยันการจอง (POST) -->
    {% if time_slots %}
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="booking_date" value="{{ selected_date }}">
        
        <h3>2. เลือกเวลา</h3>
        <div class="d-grid gap-2">
            {% for slot in time_slots %}
                <input type="radio" class="btn-check" name="start_time" id="time-{{ slot.time }}" value="{{ slot.time }}" autocomplete="off" {% if slot.status != 'available' %}disabled{% endif %}>
                <label class="btn {% if slot.status == 'available' %}btn-outline-primary{% elif slot.status == 'booked' %}btn-outline-danger{% else %}btn-outline-secondary{% endif %}" for="time-{{ slot.time }}">
                    {{ slot.time }} - {{ forloop.counter0|add:9 }}:00
                    {% if slot.status == 'booked' %} (จองแล้ว){% endif %}
                    {% if slot.status == 'past' %} (ผ่านไปแล้ว){% endif %}
                </label>
            {% endfor %}
        </div>

        <div class="d-grid">
            <button type="submit" class="btn btn-success btn-lg mt-4">ยืนยันการจอง</button>
        </div>
    </form>
    {% endif %}


    <!-- ตารางสำหรับ Staff -->
    {% if user.is_staff and bookings_for_staff %}
        <hr class="my-5">
        <h3><span class="badge bg-secondary">สำหรับ Staff</span> รายการจองทั้งหมดของห้องนี้</h3>
        <table class="table table-striped table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>ผู้จอง</th>
                    <th>วันที่</th>
                    <th>เวลา</th>
                </tr>
            </thead>
            <tbody>
                {% for booking in bookings_for_staff %}
                <tr>
                    <td>{{ booking.user.username }}</td>
                    <td>{{ booking.booking_date|date:"d M Y" }}</td>
                    <td>{{ booking.start_time|time:"H:i" }} - {{ booking.end_time|time:"H:i" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3" class="text-center">ยังไม่มีการจองสำหรับห้องนี้</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}
</div>
{% endblock %}